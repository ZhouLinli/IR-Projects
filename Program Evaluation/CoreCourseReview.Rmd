---
title: "Review Core Curriculum"
author: ""
date: ""
output: 
  word_document:
    reference_docx: /Users/linlizhou/Documents/Rprojects/lasell.report.IN-USE.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("/Users/linlizhou/Documents/Rprojects/IR-Projects/theme_source.R") #run code from saved theme and library
```




#Reporting Items

1. For each term (fall/spring): # courses/ sections offered in each core segment -- SECTION TALLY
2. For each term (fall/spring): # registration in each core segment -- SECTION TALLY 

3.  % of pass, C or better, and Withdrawal; Average GPA (and SD) of each courses -- STU INFO BY COURSE
4. All core course enrollment and transfer proportion -- deduplicated student count in STU INFO BY COURSE

5. All core course retention -- STARFISH RETENTION REPORT
6. Satisfaction -- 2018-2022 4 years of satisfaction prt in that one question containing "core"
6. course-taking sequence -- 2018 COHORT BY GRADUATION IN 2022 OR NOT -- POWERCAMPUS TRANSCRIPT

# Core Course List

```{r list of core courses}
corelist<-tibble(CourseCode=c("WRT101", "WRT102", "MATH106", "MATH107", "MATH116", "MATH202", "MATH203", "MATH203", "MATH205", "MATH208", "MATH209", "FYS103", "HON101", "MDSC203", "HON205", "PHIL302", "ARTH107", "ARTS106", "ARTS126", "ARTS205", "ENG210", "ENG217", "ENG218", "ENG225", "MUS101", "MUS102", "MUS109", "MUS203", "PERF107", "PERF111", "PERF202", "PERF203", "HIST104", "SOC104", "ANTH101", "CJ101", "COM103", "ENV101", "LS101", "PSYC101", "SOC101", "SOC102", "BIO101", "BIO102", "BIO107", "BIO113", "CHEM105", "CHEM203", "ENV206", "ENV211", "ENV220", "MATH109", "PHYS111", "PHYS112", "SCI103", "SCI104", "SCI105", "SCI106", "SCI107", "SCI114", "SCI115", "SCI117", "SCI118", "SCI119", "BIO420", "BUSS497", "CHEM407", "COM400", "CJ443", "CJ444", "DSCI499", "ED496", "ED498", "ED482", "ED484", "ED427", "EXSC410", "EXSC425", "FASH415", "FSCI407", "GRAP400", "HS415", "HS425", "HUM400", "LS443", "LS444", "BIO430", "BUSS440", "CJ441", "CJ442", "COM495", "DSCI409", "ED494", "ENG402", "EXSC430", "FASH427", "FSCI480", "GLBS401", "GRAP404", "HIST401", "HS427", "HUM419", "HUM420", "LS441", "LS442", "MATH399")) %>%
mutate(CourseGroup=case_when(CourseCode%in%c("WRT101", "WRT102") ~"Writing", 
CourseCode%in%c("MATH106", "MATH107", "MATH116", "MATH202", "MATH203", "MATH203", "MATH205", "MATH208", "MATH209") ~"Math", 
CourseCode%in%c("FYS103", "HON101")  ~ "FYS", 
CourseCode%in%c("MDSC203", "HON205")  ~ "Multidisciplinary", 
CourseCode%in%c("PHIL302")  ~ "PHIL302", 
CourseCode%in%c("ARTH107", "ARTS106", "ARTS126", "ARTS205", "ENG210", "ENG217", "ENG218", "ENG225", "MUS101", "MUS102", "MUS109", "MUS203", "PERF107", "PERF111", "PERF202", "PERF203")  ~ "Aesthetics & Creativity", 
CourseCode%in%c("HIST104")  ~ "Global & Historical", 
CourseCode%in%c("SOC104", "ANTH101", "CJ101", "COM103", "ENV101", "LS101", "PSYC101", "SOC101", "SOC102")  ~ "Individuals & Society", 
CourseCode%in%c("BIO101", "BIO102", "BIO107", "BIO113", "CHEM105", "CHEM203", "ENV206", "ENV211", "ENV220", "MATH109", "PHYS111", "PHYS112", "SCI103", "SCI104", "SCI105", "SCI106", "SCI107", "SCI114", "SCI115", "SCI117", "SCI118", "SCI119")  ~ "Scientific Inquiry & Problem Solving",
CourseCode%in%c("BIO420", "BUSS497", "CHEM407", "COM400", "CJ443", "CJ444", "DSCI499", "ED496", "ED498", "ED482", "ED484", "ED427", "EXSC410", "EXSC425", "FASH415", "FSCI407", "GRAP400", "HS415", "HS425", "HUM400", "LS443", "LS444")  ~ "Internship", 
CourseCode%in%c("BIO430", "BUSS440", "CJ441", "CJ442", "COM495", "DSCI409", "ED494", "ENG402", "EXSC430", "FASH427", "FSCI480", "GLBS401", "GRAP404", "HIST401", "HS427", "HUM419", "HUM420", "LS441", "LS442", "MATH399")  ~ "Capstone"))

#Scientific Inquiry & Problem Solving KP
#sectiontally%>%filter(grepl("^SCI|^BIO|^CHEM|^ENV|^MATH|^PHYS", event_id), 
#                      grepl("KP$", section)) %>%count(event_id)
#added the last few; and removed:  "SCI117", "SCI118", "SCI119", "MATH109", "SCI107"  in Scientific Inquiry & Problem Solving KP
```

# Section Tally dataset

```{r load crs data}
#download section tally for 2018 Fall, 2019 Spring, 2019 Fall, 2020 Spring, 2020 Fall, 2021 Spring, 2021 Fall, 2022 Spring
# var needed: coursecodes, sectiontimes, student enrollment, student grades

fa18.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally18fall.csv", skip = 2)%>%mutate(term="2018 Fall")
sp19.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally19sp.csv", skip = 2)%>%mutate(term="2019 Spring")
  
fa19.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally19fall.csv", skip = 2)%>%mutate(term="2019 Fall")
sp20.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally20sp.csv", skip = 2)%>%mutate(term="2020 Spring")

fa20.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally20fall.csv", skip = 2)%>%mutate(term="2020 Fall")
sp21.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally21sp.csv", skip = 2)%>%mutate(term="2021 Spring")

fa21.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally21fall.csv", skip = 2)%>%mutate(term="2021 Fall")
sp22.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally22sp.csv", skip = 2)%>%mutate(term="2022 Spring")

#merge
sectiontally<-plyr::join_all(list(fa18.sec, sp19.sec, fa19.sec, sp20.sec, fa20.sec, sp21.sec, fa21.sec, sp22.sec), type="full")#6246 rows

#exclude suffix in event_id: extract any number of LETTER followed by any number of NUMBER 
sectiontally<-sectiontally%>%mutate(coursecode=str_extract(event_id,"[A-Z]+[0-9]+"))#check: %>%count(coursecode)

#only keep core courses
sectiontally<-sectiontally%>%filter(sectiontally$coursecode %in% corelist$CourseCode)%>%unique()#check: %>%count(coursecode)#1338 rows

#add segment/coursegroup names col
sectiontally<-left_join(sectiontally,corelist, by=c("coursecode"="CourseCode"))%>%unique()#1338 rows

#remove invalid section (enrollment>0)
sectiontally<-sectiontally%>%filter(Current_Enrollment>0)

#factorize coursegroup for convinience showing
sectiontally<-sectiontally%>%mutate(CourseGroup=factor(CourseGroup,levels = c("Writing","Math","FYS","Multidisciplinary","PHIL302","Aesthetics & Creativity","Global & Historical","Individuals & Society","Scientific Inquiry & Problem Solving","Internship","Capstone")))

#factorize term for convinience showing
sectiontally<-sectiontally%>%mutate(term=factor(term,levels = c("2018 Fall","2019 Spring","2019 Fall","2020 Spring","2020 Fall","2021 Spring","2021 Fall","2022 Spring")))

#save: write_xlsx(sectiontally,"/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally_18FA-22SP_Core Curriculum.xlsx")
#check course and section combination is unique: sectiontally%>%count(coursecode,section,class_time,instructor,course_start_date,event_long_name)%>%filter(n>1)
```


```{r sectiont tally - number of section offered}
#For each term (fall/spring): # courses/ sections offered in each core segment -- SECTION TALLY

#number of total section offered
#sectiontally%>%group_by(CourseGroup)%>%summarise(section_n=n())

#number of term section offered
sectiontally%>%group_by(CourseGroup,term)%>%summarise(section_n=n())%>%
  pivot_wider(names_from = term, values_from = section_n)%>%
  #reorder cols
  select(CourseGroup,`2018 Fall`,`2019 Spring`,`2019 Fall`,`2020 Spring`,`2020 Fall`,`2021 Spring`,`2021 Fall`,`2022 Spring`)%>%
  View()

#investigate why no 2018fall 2019 spring data for writing?
#sectiontally%>%filter(coursecode%in%c("WRT101", "WRT102"))%>%count(term,coursecode)


#number of course offered:how many times a group appear when matching with unique coursecodes
#sectiontally%>%count(CourseGroup,coursecode)%>%count(CourseGroup)
#the same: sectiontally%>%count(CourseGroup,term,coursecode)%>%count(term,CourseGroup)#how many times a group appear when matching with unique coursecodes
```


```{r sectiont tally - number of registration}
# For each term (fall/spring): # registration in each core segment -- SECTION TALLY 
sectiontally%>%group_by(CourseGroup,term)%>%summarise(enrollment=sum(Current_Enrollment))%>%
  pivot_wider(names_from = term, values_from = enrollment)%>%
  #reorder cols
  select(CourseGroup,`2018 Fall`,`2019 Spring`,`2019 Fall`,`2020 Spring`,`2020 Fall`,`2021 Spring`,`2021 Fall`,`2022 Spring`)%>%
  View()
```

# Student Info by Course dataset

```{r load student data}
# download stu info by course for 18-19, 19-20, 20-21, 21-22
# var needed: core course students' transfer status, unduplicated total enroll
crs18_19<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Student Info by Course and Fiscal Year18-19.csv")
crs19_20<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Student Info by Course and Fiscal Year19-20.csv")
crs20_21<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Student Info by Course and Fiscal Year20-21.csv")
crs21_22<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Student Info by Course and Fiscal Year21-22.csv")
#merge
stucrs<-plyr::join_all(list(crs18_19,crs19_20,crs20_21,crs21_22), type="full")#110588 rows

#only fall-spring term
stucrs<-stucrs%>%filter(academic_term%in%c("FALL","SPRING"))#101559

#exclude suffix in Course_ID: extract any number of LETTER followed by any number of NUMBER 
stucrs<-stucrs%>%mutate(coursecode=str_extract(Course_ID,"[A-Z]+[0-9]+"))#check: %>%count(coursecode)

#only keep core courses
stucrs<-stucrs%>%filter(stucrs$coursecode %in% corelist$CourseCode)%>%unique()#check: %>%count(coursecode)#29424 rows

#add segment/coursegroup names col
stucrs<-left_join(stucrs,corelist, by=c("coursecode"="CourseCode"))%>%unique()#29424 rows



#factorize coursegroup for convinience showing
stucrs<-stucrs%>%mutate(CourseGroup=factor(CourseGroup,levels = c("Writing","Math","FYS","Multidisciplinary","PHIL302","Aesthetics & Creativity","Global & Historical","Individuals & Society","Scientific Inquiry & Problem Solving","Internship","Capstone")))

#mutate and factorize term for convinience showing
stucrs<-stucrs%>%mutate(term=paste(academic_year,academic_term,sep=" "),
                        term=factor(term,levels = c("2018 FALL","2019 SPRING","2019 FALL","2020 SPRING","2020 FALL","2021 SPRING","2021 FALL","2022 SPRING")))

#save: write_xlsx(stucrs,"/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/StudentInfoCourse_18FA-22SP_Core Curriculum.xlsx")
#check course and section combination is unique: 

stucrs%>%count(people_code_id,coursecode,Course_section,Course_Name,Instructor_ids,Add_Drop, term)%>%filter(n>1)

stucrs%>%filter(people_code_id=="P000053284",coursecode=="CHEM203",Course_section=="B",term=="2019 FALL")

stucrs%>%count(Final_Grade)
```

```{r dediplicated headcount}
# All core course enrollment and transfer proportion -- deduplicated student count in STU INFO BY COURSE
## filter students who have valid final grade (count only those with an A in the Add_Drop column--hopefually they all have a nonNA final grade), and deduplicate them
stucrs.18fa<-stucrs%>%filter(term=="2018 FALL")%>%distinct(people_code_id)%>%nrow()
stucrs.19sp<-stucrs%>%filter(term=="2019 SPRING")%>%distinct(people_code_id)%>%nrow()
stucrs.19fa<-stucrs%>%filter(term=="2019 FALL")%>%distinct(people_code_id)%>%nrow()
stucrs.20sp<-stucrs%>%filter(term=="2020 SPRING")%>%distinct(people_code_id)%>%nrow()
stucrs.20fa<-stucrs%>%filter(term=="2020 FALL")%>%distinct(people_code_id)%>%nrow()
stucrs.21sp<-stucrs%>%filter(term=="2021 SPRING")%>%distinct(people_code_id)%>%nrow()
stucrs.21fa<-stucrs%>%filter(term=="2021 FALL")%>%distinct(people_code_id)%>%nrow()
stucrs.22sp<-stucrs%>%filter(term=="2022 SPRING")%>%distinct(people_code_id)%>%nrow()

tibble( term=c("2018 FALL","2019 SPRING","2019 FALL","2020 SPRING","2020 FALL","2021 SPRING","2021 FALL","2022 SPRING"),enrolled=c(stucrs.18fa,stucrs.19sp,stucrs.19fa,stucrs.20sp,stucrs.20fa,stucrs.21sp,stucrs.21fa,stucrs.22sp))%>%pivot_wider(names_from = term, values_from = enrolled)%>%View()
```


```{r clean stucrs.grade}
stucrs%>%count(Final_Grade)
#clean
stucrs.grade<-stucrs%>%filter(Final_Grade%in%c("F", "W", "A", "A-", "B+", "B", "B-", "C+", "C", "P",
                                               "D","D+","D-"))%>%
#regroup
  mutate(grade=if_else(Final_Grade%in%c("A", "A-", "B+", "B", "B-", "C+", "C", "P"), "C or better",
                       if_else(Final_Grade%in%c("D","D+","D-"),"D",Final_Grade)),
#convert
        GPA=case_when(Final_Grade=="F"~"0",Final_Grade=="A"~"4.0",Final_Grade=="A-"~"3.7",
                      Final_Grade=="B+"~"3.3",Final_Grade=="B"~"3",Final_Grade=="B-"~"2.7",
                      Final_Grade=="C+"~"2.3",Final_Grade=="C"~"2",Final_Grade=="C-"~"1.7",
                      Final_Grade=="D+"~"1.3",Final_Grade=="D"~"1",Final_Grade=="D-"~"0.7"))
#save: write_xlsx(stucrs.grade,"/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/StudentInfoCourse_18FA-22SP_Core Curriculum.xlsx")
```


```{r GPA for each segment}
# % of pass (not F or W) for each segment
stucrs.grade%>%group_by(term,CourseGroup,grade)%>%summarise(cnt=n())%>%mutate(prt=cnt/sum(cnt))%>%View()
  enro
# % of C or better (A, A-, B+, B, B-, C+, C or P)

# % of Withdrawal (W)

# Average GPA (and SD): keep only "F, W, A, A-, B+, B, B-, C+, C"
```












