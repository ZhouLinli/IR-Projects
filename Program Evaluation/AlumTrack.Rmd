---
title: "AlumTracking"
author: "Linli Zhou"
date: "2022-08-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load package}
library(readxl)
library(dplyr)
```

# Research question: 
1. Postgrad Life Basic: 1) How many alumni are employed/unemployed/continue-ed across years? 2) What are the most popular title/degree and employers/institutions?

- variables needed: 1) EMPLOYED, TITLE, EMPLOYER; 2) not/continue-ed+institution/degree
- data source: 1) historical.data append with survey and linkedin; 2)clearinghouse

2. What are alum's top interests in Lasell alum activities?

- variables needed: INTEREST
- data source: historical.data append with survey

3. Employ-ability/Continue-edu characteristics: 1) Which major/degree are most employable across different years for grad and undergrad? 2) How demographic (gender, race) correlate with employment?

- variables needed: level/gradyear,school/major/degree, gender/race
- data source: ipeds.complete.16-current

# Data Prep 


## GD Alumni 6 month

```{r read gd6m data}
#gd6m target data
#find sheet
excel_sheets("/Users/linlizhou/Documents/LASELL/data/alumni/2021Grad6m_historic.xlsx")#only one sheet
#read historical data
gd6m<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/2021Grad6m_historic.xlsx")

#read survey data
survey<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/2021Gd6mSurvey_renamed.xlsx")

#read linkedin data
linkedin<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/2021Gd6mLinkedin_rename.xlsx")
```

```{r gd6m-select vars}
#select gd6m vars to be gd6m_s 
gd6m_s<-gd6m%>%select(
  PC_ID, 
  `Employed/Ed`, #EMPLOYED VAR
  Employment_Organization, #EMPLOYER VAR
  Employment_JobTitle, #TITLE VAR
  Employed_income...30, #INCOME CAT VAR
  starts_with("Interest_")#INTEREST VAR
)
#rename for consistency across all df
names(gd6m_s)<-c("PCID","Employment","Employer","Title","Income",names(gd6m_s)[6:15])
#check col number
ncol(gd6m_s)

######select survey to be survey_s
survey_s<-survey%>%select(
  PC_ID,
  `Employment/Unemployed`,
  Employment_Organization,
  Employment_JobTitle,
  Employed_income,
  starts_with("Interest_")
  )
#rename for consistency across all df
names(survey_s)<-c("PCID","Employment","Employer","Title","Income",names(survey_s)[6:15])
#check col number
ncol(survey_s)

#######select linkedin to be linkedin_s
linkedin_s<-linkedin%>%select(
  PC_ID,
  Employment,
  Employment_Organization,
  Employment_JobTitle
)
#rename for consistency across all df
names(linkedin_s)<-c("PCID","Employment","Employer","Title")
```

```{r gd6m-join_all}
#check rows
nrow(gd6m_s)+nrow(survey_s)+nrow(linkedin_s)#1404 rows
#join_all by all common cols
gd6m_m<-plyr::join_all(list(gd6m_s,survey_s,linkedin_s),type="full",match="all")#1404 rows; must use list(dfs)

#save
writexl::write_xlsx(gd6m_m,"/Users/linlizhou/Documents/LASELL/data/alumni/gd6m_merged.xlsx")
#rm unused cols
rm(gd6m,gd6m_s,survey,survey_s,linkedin,linkedin_s)
```

## GD 5 year
```{r read gd5yr data and select var}
gd5yr<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/grad5y_full.xlsx")

gd5yr<-gd5yr%>%select(
  PCID, 
  `Employed/UnEmployed`, #EMPLOYED VAR
  `Employer Name`, #EMPLOYER VAR
  Title, #TITLE VAR
  names(gd5yr)[17], #INCOME CAT VAR
  names(gd5yr)[46:49],
  names(gd5yr)[51:56]#INTEREST VAR
)
#rename for consistency across all df
names(gd5yr)<-names(gd6m_m)
```

## UG 6 month

```{r read ug6m}
#####ug6m data
#which is data sheet
excel_sheets("/Users/linlizhou/Documents/LASELL/data/alumni/ug6m/bd.xlsx")
#read data
ug6m<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/ug6m/bd.xlsx",sheet = "AllData")

#check names
names(ug6m)
#select
ug6m_s<-ug6m%>%select(PCID,Status,names(ug6m)[12:13],names(ug6m)[18],names(ug6m)[42:45],names(ug6m)[47:52])#omit 46th which is peer network
#investigate names to prep rename
names(ug6m_s)
names(gd6m_m)[6:15]
#rename to match other datasets (for later alrge merge)
names(ug6m_s)<-c("PCID","Employment","Employer","Title","Income",names(gd6m_m)[6:15])
#check again looks aligned with gd6m_m


######survey data
#read data
excel_sheets("/Users/linlizhou/Documents/LASELL/data/alumni/ug6m/survey.xlsx")
survey<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/ug6m/survey.xlsx",sheet = "Sheet1")
#select data
survey<-survey%>%select(PCID,Status,names(survey)[12:13],names(survey)[18],names(survey)[42:45],names(survey)[47:52])
#rename to match other datasets (for later alrge merge)
names(survey)<-c("PCID","Employment","Employer","Title","Income",names(gd6m_m)[6:15])
#check again looks aligned with gd6m_m

######linkedin data
#read data
linkedin<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/ug6m/linkedin.xlsx")
#select var
linkedin<-linkedin%>%select(`Power Campus ID`,`Employed (FT/PT)`,Employer,Title)%>%rename("PCID"=`Power Campus ID`,"Employment"=`Employed (FT/PT)`)
#check
names(linkedin)

######merge
ug6m_m<-plyr::join_all(list(ug6m_s,survey,linkedin),type="full",match="first")#602 observation

#save
writexl::write_xlsx(ug6m_m,"/Users/linlizhou/Documents/LASELL/data/alumni/ug6m_merged.xlsx")
#rm
rm(ug6m,ug6m_s,linkedin,survey)
```

## UG 5year

```{r read data}
#read historical data
excel_sheets("/Users/linlizhou/Documents/LASELL/data/alumni/ug5y/db.xlsx")
ug5y<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/ug5y/db.xlsx",sheet = "Data")

#select vars
ug5y<-ug5y%>%select(PC_ID,WorkStatus,Organization,AnnualSalary,starts_with("Interest_"),-names(ug5y)[27])

names(ug5y)<-c("PCID","Employment","Employer","Income",names(gd6m_m)[6:15])#names align with other (excep it does not have title)

#####survey
#read data 
survey<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/ug5y/survey.xlsx")
#names
names(survey)
survey<-survey%>%select(
  `Invite Custom Field 1`,
  names(survey)[54],#employment work status
  names(survey)[71],#employer
  names(survey)[70],#title
  names(survey)[74],#income
  names(survey)[136:139],
  names(survey)[141:146]
)

names(survey)<-names(gd6m_m)

####linkedin
#which sheet to read
excel_sheets("/Users/linlizhou/Documents/LASELL/data/alumni/ug5y/linkedin.xlsx")
#read data
linkedin<-read_excel("/Users/linlizhou/Documents/LASELL/data/alumni/ug5y/linkedin.xlsx",sheet = "Sheet1")

#select var
linkedin<-linkedin%>%select(`Power Campus ID`,`Employed (FT/PT)`,Employer,Title)%>%rename("PCID"=`Power Campus ID`,"Employment"=`Employed (FT/PT)`)
#check
names(linkedin)

######merge
ug5y_m<-plyr::join_all(list(ug5y,survey,linkedin),type="full",match="first")#602 observation

#save
writexl::write_xlsx(ug5y_m,"/Users/linlizhou/Documents/LASELL/data/alumni/ug5y_merged.xlsx")
#rm
rm(ug5y,linkedin,survey)
```


#Merge and Clean Large Dataset

```{r mutate 5y/6m col}
#read data

#add col to indicate the focus of outcome in each dataset
gd5yr<-gd5yr%>%mutate("Outcome Type"="5-Year Outcome")
ug5y_m<-ug5y_m%>%mutate("Outcome Type"="5-Year Outcome")
gd6m_m<-gd6m_m%>%mutate("Outcome Type"="6-Month Outcome")
ug6m_m<-ug6m_m%>%mutate("Outcome Type"="6-Month Outcome")
```

```{r merge large dataset}
#merge
alum<-plyr::join_all(list(gd5yr,gd6m_m,ug5y_m,ug6m_m),type="full")
```

```{r interest var -mutate based on other col}
#combine multi-col into one INTEREST var
alum<-alum%>%mutate(Interest=case_when(
  Interest_AlumnCareerNetwork=="Alumni Career Network"~"Career Network",
  
  Interest_JobPosts=="Posting jobs or internships listings for Lasell students"~"Post Jobs",
  
  Interest_CareerFair=="Career Fair" | 
    Interest_CollegeFair=="College Fair"~"Career/College Fair",
  
  Interest_Volunteering=="Volunteering at Lasell events" | 
    Interest_CampusPresentation=="Campus presentation to students" | 
    Interest_Mentor=="Being a mentor to current students" ~"Volunteer",
  
Interest_SocialActivities == "Social activities (sporting events, reunion, etc.)" | 
Interest_Recreational=="Recreational programs (kayaking, hiking, etc.)" ~ "Social",
  
   Interest_AcademicCultural=="Academic/Cultural (lectures, theater, etc.)" ~ "Academic/Cultural"
   ))

#remove all "Interest_" subcols and only keep Interest (mutated conclusive col)
alum<-alum%>%select(-starts_with("Interest_"))
```


```{r recode employment}
#need to revise employement var selection; changed the recoded one to the orginal one -- so that we can make a both employed and continue add value type

######inspect employment
alum%>%group_by(Employment)%>%count()
#recode employed
alum$Employment<-alum$Employment%>%recode(
  "FT"="Employed","Intern"="Employed","PT"="Employed","Self"="Employed","Temp"="Employed","Y"="Employed","Yes"="Employed",
  "U"="Unknown","NA"="Unknown",
  "N"="Unemployed","No"="Unemployed")

#recode using case_when (mutate same variable name to replace the origional Employment)
alum<-alum%>%mutate(Employment=case_when(
  Employment %in% c("Additional Eduation","Additional Education","Edu","Further Ed","n/a","Other","UNK","Unknown") ~ "Unknown",
  Employment %in% c("Contract","Emp","EmpEdu","employed","Employed","Freelance","Internship") ~ "Employed",
  Employment %in% c("No Emp No Edu","Unemployed")~"Unemployed"
))

#check
alum%>%group_by(Employment)%>%count()#NA cannot be recoded
#rename NA with subset 
alum$Employment[is.na(alum$Employment)]="Unknown"#recheck looks right
```


```{r recode income}
######inspect income
alum%>%group_by(Income)%>%count()#observe "to" and "-" interchangabily
#replace to with -
alum$Income<-gsub("to","-",alum$Income)

#recode other out of the "to" pattern 
alum$Income<-alum$Income%>%recode(
   "$100,000 or over" = ">$100,000","$100,000 or more" = ">$100,000",
  "$90,000 or over"="$90,000 - $99,999",
  "$80,000 or over"= "$80,000 - $89,999",
  "Less than $40,000"="$30,000 - $39,999",
  "$20,000 - $29,999"="Less than $30,000",
  "$24,999 or less"="Less than $30,000",
  "Less than $20,000"= "Less than $30,000",
  "Prefer not - state"="Unknown",
  "I prefer not - state"="Unknown"
)

#recode NA
alum$Income[is.na(alum$Income)]="Unknown"#recheck looks right

#check
alum%>%group_by(Income)%>%count()
```


## Add IPEDS.Complete

```{r ipeds for merge clean df}
#read ipeds data (prepared with PCID, level, degree, major, gradate, race, gender, school)
ipeds.16crt<-read_excel("/Users/linlizhou/Documents/LASELL/data/completion/16-current.xlsx")
#merge to alum.m large dataset
alum.m<-plyr::join_all(list(alum,ipeds.16crt),type="left")
```


```{r save large dataset}
writexl::write_xlsx(alum.m,"/Users/linlizhou/Documents/LASELL/data/alumni/alum.xlsx")
```



