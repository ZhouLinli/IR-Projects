---
title: "Review Core Curriculum"
author: ""
date: ""
output: 
  word_document:
    reference_docx: /Users/linlizhou/Documents/Rprojects/lasell.report.IN-USE.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("/Users/linlizhou/Documents/Rprojects/IR-Projects/theme_source.R") #run code from saved theme and library
```




#Reporting Items

1. For each term (fall/spring): # courses/ sections offered in each core segment -- SECTION TALLY
2. For each term (fall/spring): # registration in each core segment -- SECTION TALLY 

3.  % of pass, C or better, and Withdrawal; Average GPA (and SD) of each courses -- STU INFO BY COURSE
4. All core course enrollment and transfer proportion -- deduplicated student count in STU INFO BY COURSE

5. All core course retention -- STARFISH RETENTION REPORT
6. Satisfaction -- 2018-2022 4 years of satisfaction prt in that one question containing "core"
6. course-taking sequence -- 2018 COHORT BY GRADUATION IN 2022 OR NOT -- POWERCAMPUS TRANSCRIPT

# Core Course List

```{r list of core courses}
corelist<-tibble(CourseCode=c("WRT101", "WRT102","ENG101","ENG102","MATH106", "MATH107", "MATH116", "MATH202", "MATH203", "MATH203", "MATH205", "MATH208", "MATH209", "FYS103", "HON101", "MDSC203", "HON205", "PHIL302", "ARTH107", "ARTS106", "ARTS126", "ARTS205", "ENG210", "ENG217", "ENG218", "ENG225", "MUS101", "MUS102", "MUS109", "MUS203", "PERF107", "PERF111", "PERF202", "PERF203", "HIST104", "SOC104", "ANTH101", "CJ101", "COM103", "ENV101", "LS101", "PSYC101", "SOC101", "SOC102", "BIO101", "BIO102", "BIO107", "BIO113", "CHEM105", "CHEM203", "ENV206", "ENV211", "ENV220", "MATH109", "PHYS111", "PHYS112", "SCI103", "SCI104", "SCI105", "SCI106", "SCI107", "SCI114", "SCI115", "SCI117", "SCI118", "SCI119", "BIO420", "BUSS497", "CHEM407", "COM400", "CJ443", "CJ444", "DSCI499", "ED496", "ED498", "ED482", "ED484", "ED427", "EXSC410", "EXSC425", "FASH415", "FSCI407", "GRAP400", "HS415", "HS425", "HUM400", "LS443", "LS444", "BIO430", "BUSS440", "CJ441", "CJ442", "COM495", "DSCI409", "ED494", "ENG402", "EXSC430", "FASH427", "FSCI480", "GLBS401", "GRAP404", "HIST401", "HS427", "HUM419", "HUM420", "LS441", "LS442", "MATH399")) %>%
mutate(CourseGroup=case_when(CourseCode%in%c("WRT101", "WRT102","ENG101","ENG102") ~"Writing", 
CourseCode%in%c("MATH106", "MATH107", "MATH116", "MATH202", "MATH203", "MATH203", "MATH205", "MATH208", "MATH209") ~"Math", 
CourseCode%in%c("FYS103", "HON101")  ~ "FYS", 
CourseCode%in%c("MDSC203", "HON205")  ~ "Multidisciplinary", 
CourseCode%in%c("PHIL302")  ~ "PHIL302", 
CourseCode%in%c("ARTH107", "ARTS106", "ARTS126", "ARTS205", "ENG210", "ENG217", "ENG218", "ENG225", "MUS101", "MUS102", "MUS109", "MUS203", "PERF107", "PERF111", "PERF202", "PERF203")  ~ "Aesthetics & Creativity", 
CourseCode%in%c("HIST104")  ~ "Global & Historical", 
CourseCode%in%c("SOC104", "ANTH101", "CJ101", "COM103", "ENV101", "LS101", "PSYC101", "SOC101", "SOC102")  ~ "Individuals & Society", 
CourseCode%in%c("BIO101", "BIO102", "BIO107", "BIO113", "CHEM105", "CHEM203", "ENV206", "ENV211", "ENV220", "MATH109", "PHYS111", "PHYS112", "SCI103", "SCI104", "SCI105", "SCI106", "SCI107", "SCI114", "SCI115", "SCI117", "SCI118", "SCI119")  ~ "Scientific Inquiry & Problem Solving",
CourseCode%in%c("BIO420", "BUSS497", "CHEM407", "COM400", "CJ443", "CJ444", "DSCI499", "ED496", "ED498", "ED482", "ED484", "ED427", "EXSC410", "EXSC425", "FASH415", "FSCI407", "GRAP400", "HS415", "HS425", "HUM400", "LS443", "LS444")  ~ "Internship", 
CourseCode%in%c("BIO430", "BUSS440", "CJ441", "CJ442", "COM495", "DSCI409", "ED494", "ENG402", "EXSC430", "FASH427", "FSCI480", "GLBS401", "GRAP404", "HIST401", "HS427", "HUM419", "HUM420", "LS441", "LS442", "MATH399")  ~ "Capstone"))

#Scientific Inquiry & Problem Solving KP
#sectiontally%>%filter(grepl("^SCI|^BIO|^CHEM|^ENV|^MATH|^PHYS", event_id), 
#                      grepl("KP$", section)) %>%count(event_id)
#added the last few; and removed:  "SCI117", "SCI118", "SCI119", "MATH109", "SCI107"  in Scientific Inquiry & Problem Solving KP
```

# Section Tally dataset

```{r load crs data}
#download section tally for 2018 Fall, 2019 Spring, 2019 Fall, 2020 Spring, 2020 Fall, 2021 Spring, 2021 Fall, 2022 Spring
# var needed: coursecodes, sectiontimes, student enrollment, student grades

fa18.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally18fall.csv", skip = 2)%>%mutate(term="2018 Fall")
sp19.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally19sp.csv", skip = 2)%>%mutate(term="2019 Spring")
  
fa19.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally19fall.csv", skip = 2)%>%mutate(term="2019 Fall")
sp20.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally20sp.csv", skip = 2)%>%mutate(term="2020 Spring")

fa20.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally20fall.csv", skip = 2)%>%mutate(term="2020 Fall")
sp21.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally21sp.csv", skip = 2)%>%mutate(term="2021 Spring")

fa21.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally21fall.csv", skip = 2)%>%mutate(term="2021 Fall")
sp22.sec<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally22sp.csv", skip = 2)%>%mutate(term="2022 Spring")

#merge
sectiontally<-plyr::join_all(list(fa18.sec, sp19.sec, fa19.sec, sp20.sec, fa20.sec, sp21.sec, fa21.sec, sp22.sec), type="full")#6246 rows

#exclude suffix in event_id: extract any number of LETTER followed by any number of NUMBER 
sectiontally<-sectiontally%>%mutate(coursecode=str_extract(event_id,"[A-Z]+[0-9]+"))#check: %>%count(coursecode)

#only keep core courses
sectiontally<-sectiontally%>%filter(sectiontally$coursecode %in% corelist$CourseCode)%>%unique()#check: %>%count(coursecode)#1338 rows

#add segment/coursegroup names col
sectiontally<-left_join(sectiontally,corelist, by=c("coursecode"="CourseCode"))%>%unique()#1338 rows

#remove invalid section (enrollment>0)
sectiontally<-sectiontally%>%filter(Current_Enrollment>0)

#factorize coursegroup for convinience showing
sectiontally<-sectiontally%>%mutate(CourseGroup=factor(CourseGroup,levels = c("Writing","Math","FYS","Multidisciplinary","PHIL302","Aesthetics & Creativity","Global & Historical","Individuals & Society","Scientific Inquiry & Problem Solving","Internship","Capstone")))

#factorize term for convinience showing
sectiontally<-sectiontally%>%mutate(term=factor(term,levels = c("2018 Fall","2019 Spring","2019 Fall","2020 Spring","2020 Fall","2021 Spring","2021 Fall","2022 Spring")))

#save: write_xlsx(sectiontally,"/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Section Tally_18FA-22SP_Core Curriculum.xlsx")
#check course and section combination is unique: sectiontally%>%count(coursecode,section,class_time,instructor,course_start_date,event_long_name)%>%filter(n>1)
```


```{r sectiont tally - number of section offered}
#For each term (fall/spring): # courses/ sections offered in each core segment -- SECTION TALLY

#number of total section offered
#sectiontally%>%group_by(CourseGroup)%>%summarise(section_n=n())

#number of term section offered
sectiontally%>%group_by(CourseGroup,term)%>%summarise(section_n=n())%>%
  pivot_wider(names_from = term, values_from = section_n)%>%
  #reorder cols
  select(CourseGroup,`2018 Fall`,`2019 Spring`,`2019 Fall`,`2020 Spring`,`2020 Fall`,`2021 Spring`,`2021 Fall`,`2022 Spring`)%>%
  View()

#investigate why no 2018fall 2019 spring data for writing?
#sectiontally%>%filter(coursecode%in%c("WRT101", "WRT102"))%>%count(term,coursecode)


#number of course offered:how many times a group appear when matching with unique coursecodes
#sectiontally%>%count(CourseGroup,coursecode)%>%count(CourseGroup)
#the same: sectiontally%>%count(CourseGroup,term,coursecode)%>%count(term,CourseGroup)#how many times a group appear when matching with unique coursecodes
```


```{r sectiont tally - number of registration}
# For each term (fall/spring): # registration in each core segment -- SECTION TALLY 
sectiontally%>%group_by(CourseGroup,term)%>%summarise(enrollment=sum(Current_Enrollment))%>%
  pivot_wider(names_from = term, values_from = enrollment)%>%
  #reorder cols
  select(CourseGroup,`2018 Fall`,`2019 Spring`,`2019 Fall`,`2020 Spring`,`2020 Fall`,`2021 Spring`,`2021 Fall`,`2022 Spring`)%>%
  View()
```

```{r solve NA problem in WRI in 18fall/19}
#since we have NA section for WRI101/102 in 18fall/19spring, we investigated the raw data
sp19.sec%>%#filter(term=="2018 Fall")%>%
  #count(coursecode,event_long_name)
  filter(str_detect(event_long_name,"Writing"))%>%count(event_long_name,event_id)
#found ENG101/102 as writing course too -- edited corecourse list and everything else updated done
```



# Student Info by Course dataset

```{r load student data}
# download stu info by course for 18-19, 19-20, 20-21, 21-22
# var needed: core course students' transfer status, unduplicated total enroll
crs18_19<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Student Info by Course and Fiscal Year18-19.csv")
crs19_20<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Student Info by Course and Fiscal Year19-20.csv")
crs20_21<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Student Info by Course and Fiscal Year20-21.csv")
crs21_22<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/Student Info by Course and Fiscal Year21-22.csv")
#merge
stucrs<-plyr::join_all(list(crs18_19,crs19_20,crs20_21,crs21_22), type="full")#110588 rows

#only fall-spring term
stucrs<-stucrs%>%filter(academic_term%in%c("FALL","SPRING"))#101559

#exclude suffix in Course_ID: extract any number of LETTER followed by any number of NUMBER 
stucrs<-stucrs%>%mutate(coursecode=str_extract(Course_ID,"[A-Z]+[0-9]+"))#check: %>%count(coursecode)

#only keep core courses
stucrs<-stucrs%>%filter(stucrs$coursecode %in% corelist$CourseCode)%>%unique()#check: %>%count(coursecode)#29424 rows

#add segment/coursegroup names col
stucrs<-left_join(stucrs,corelist, by=c("coursecode"="CourseCode"))%>%unique()#29424 rows



#factorize coursegroup for convinience showing
stucrs<-stucrs%>%mutate(CourseGroup=factor(CourseGroup,levels = c("Writing","Math","FYS","Multidisciplinary","PHIL302","Aesthetics & Creativity","Global & Historical","Individuals & Society","Scientific Inquiry & Problem Solving","Internship","Capstone")))

#mutate and factorize term for convinience showing
stucrs<-stucrs%>%mutate(term=paste(academic_year,academic_term,sep=" "),
                        term=factor(term,levels = c("2018 FALL","2019 SPRING","2019 FALL","2020 SPRING","2020 FALL","2021 SPRING","2021 FALL","2022 SPRING")))
```

# Unduplicated student taking core courses

```{r deduplicated student count by term}
stucrs%>%group_by(term)%>%summarise(n=n_distinct(people_code_id))
#%>%select(n)%>%colSums(n)#10549 ppid adding separate terms together
  pivot_wider(names_from = term,values_from = n)%>%View()
```

```{r unduplicated student list for transfer status}
#unduplicated student list: distinctive ppid for each term
stucrs.id<-stucrs%>%group_by(term)%>%distinct(people_code_id)

#transfer status in dtm
dmt<-read_excel("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Datamart Files/DataMart To Date/Final Datamart up to Date 09262022.xlsx")
dmt.transfer<-dmt%>%select(PC_ID,TRANSFER_YN)
#merge
stucrs.id<-left_join(stucrs.id,dmt.transfer,by=c("people_code_id"="PC_ID"))

#transfer status percent
stucrs.id%>%group_by(term,TRANSFER_YN)%>%summarise(cnt=n())%>%
  mutate(prt=formattable::percent(cnt/sum(cnt),digits = 0))%>%
  filter(TRANSFER_YN=="Y")%>%select(term,prt)%>%
  pivot_wider(names_from = term, values_from = prt)%>%View()
```


# stucrs.grade: Valid grade filtered

```{r clean stucrs.grade}
#check course and section combination is unique: 
stucrs%>%count(people_code_id,coursecode,Course_section,Course_Name,Instructor_ids,Add_Drop, term)%>%filter(n>1)#appeared twice
#check one of those twice appearance: stucrs%>%filter(people_code_id=="P000053284",coursecode=="CHEM203",Course_section=="B",term=="2019 FALL")
##it's due to two different final grades (one for lab)

#investigate final grades:
stucrs%>%count(Final_Grade)
#clean final grades
stucrs.grade<-stucrs%>%filter(Final_Grade%in%c("F", "W", "A", "A-", "B+", "B", "B-", "C+", "C", "P",
                                               "D","D+","D-"))%>%
#regroup
  mutate(grade=if_else(Final_Grade%in%c("A", "A-", "B+", "B", "B-", "C+", "C", "P"), "C or better",
                       if_else(Final_Grade%in%c("D","D+","D-"),"D",Final_Grade)),
#convert
        GPA=case_when(Final_Grade=="F"~"0",Final_Grade=="A"~"4.0",Final_Grade=="A-"~"3.7",
                      Final_Grade=="B+"~"3.3",Final_Grade=="B"~"3",Final_Grade=="B-"~"2.7",
                      Final_Grade=="C+"~"2.3",Final_Grade=="C"~"2",Final_Grade=="C-"~"1.7",
                      Final_Grade=="D+"~"1.3",Final_Grade=="D"~"1",Final_Grade=="D-"~"0.7"),
        GPA=as.numeric(GPA))
#save: write_xlsx(stucrs.grade,"/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Data and Analyses/Program Review/2022 Core Curriculum/data files/StudentInfoCourse_18FA-22SP_Core Curriculum.xlsx")
```


```{r report C/Pass/Withdraw}
# % of C or better (A, A-, B+, B, B-, C+, C or P)
# % of pass (not F or W) for each segment
# % of Withdrawal (W)
stucrs.grade%>%group_by(term,grade)%>%summarise(cnt=n())%>%
  mutate(prt=formattable::percent(cnt/sum(cnt),digits = 0))%>%
  select(-cnt)%>%pivot_wider(names_from = term,values_from = prt)%>%View()

# by segment/coursegroup

##figuring out how to order vars in group by:
#stucrs.grade%>%filter(term=="2018 FALL")%>%
#  group_by(CourseGroup,grade)%>%summarise(cnt=n())%>%
#  mutate(prt=formattable::percent(cnt/sum(cnt),digits = 0))%>%
#  select(-cnt)%>%pivot_wider(names_from = grade,values_from = prt)%>%View()

##OVERALL
stucrs.grade%>%
  group_by(term,CourseGroup,grade)%>%summarise(cnt=n())%>%
  mutate(prt=formattable::percent(cnt/sum(cnt),digits = 0))%>%
  select(-cnt)%>%pivot_wider(names_from = term,values_from = prt)%>%
  View()

#C or better by coursegroup
stucrs.grade%>%
  group_by(term,CourseGroup,grade)%>%summarise(cnt=n())%>%
  mutate(prt=formattable::percent(cnt/sum(cnt),digits = 0))%>%
  filter(grade%in%c("C or better"))%>%
  select(-cnt)%>%pivot_wider(names_from = grade, values_from = prt)%>%
  pivot_wider(names_from = term,values_from = `C or better`)%>%
  View()

#pass
stucrs.grade%>%
  group_by(term,CourseGroup,grade)%>%summarise(cnt=n())%>%
  #mutate(prt=formattable::percent(cnt/sum(cnt),digits = 0))%>%
  mutate(prt=cnt/sum(cnt))%>%
  filter(grade%in%c("C or better","D"))%>%
  select(-cnt)%>%pivot_wider(names_from = grade, values_from = prt)%>%
  replace(is.na(.), 0)%>%
  mutate(pass=`C or better`+D)%>%select(-`C or better`,-D)%>%
  mutate(pass=formattable::percent(pass,digits = 0))%>%
  pivot_wider(names_from = term,values_from = pass)%>%
  View()

#withdrawl by coursegroup
stucrs.grade%>%
  group_by(term,CourseGroup,grade)%>%summarise(cnt=n())%>%
  #mutate(prt=formattable::percent(cnt/sum(cnt),digits = 0))%>%
  mutate(prt=cnt/sum(cnt))%>%filter(grade=="W")%>%
  replace(is.na(.), 0)%>%#actually prt have no NA values
  select(-cnt)%>%pivot_wider(names_from = term,values_from = prt)%>%#it is after pivotwider that some terms do not have a value (i.e. have NA)
 # replace(is.na(.), 0)%>%#actually prt have no NA values
  View()
```


```{r report GPA}
# Average GPA (and SD): 
stucrs.grade%>%group_by(term)%>%summarise(mn=round(mean(GPA,na.rm=T),digits = 2),
                                          sd=round(sd(GPA,na.rm=T),digits = 2))%>%View()#tanspose when paste
#GPA by segment/coursegroup
stucrs.grade%>%group_by(term,CourseGroup)%>%summarise(mn=round(mean(GPA,na.rm=T),digits = 2))%>%
  pivot_wider(names_from = term,values_from = mn)%>%
  View()
```


```{r focus on FYS/SciInq}
#In grade table, FYS in spring and SciInq in fall has weried pattern of being sig. lower. To investigate what are the most at-risk courses: 
#lay out all FYS/SciInq courses by term (fall vs spring) w/t % pass

#stucrs.grade%>%count(CourseGroup)
#FYS
stucrs.grade%>%filter(CourseGroup%in%c("FYS"))%>%
  group_by(term,coursecode,grade)%>%summarise(cnt=n())%>%
  #mutate(prt=formattable::percent(cnt/sum(cnt),digits = 0))%>%
  mutate(prt=cnt/sum(cnt))%>%
  filter(grade%in%c("C or better","D"))%>%
  select(-cnt)%>%pivot_wider(names_from = grade, values_from = prt)%>%
  replace(is.na(.), 0)%>%
  mutate(pass=`C or better`+D)%>%select(-`C or better`,-D)%>%
  mutate(pass=formattable::percent(pass,digits = 0))%>%
  pivot_wider(names_from = term,values_from = pass)%>%
  View()

#SciInq
stucrs.grade%>%filter(CourseGroup%in%c("Scientific Inquiry & Problem Solving"))%>%
  group_by(term,coursecode,grade)%>%summarise(cnt=n())%>%
  #mutate(prt=formattable::percent(cnt/sum(cnt),digits = 0))%>%
  mutate(prt=cnt/sum(cnt))%>%
  filter(grade%in%c("C or better","D"))%>%
  select(-cnt)%>%pivot_wider(names_from = grade, values_from = prt)%>%
  replace(is.na(.), 0)%>%
  mutate(pass=`C or better`+D)%>%select(-`C or better`,-D)%>%
  mutate(pass=formattable::percent(pass,digits = 0))%>%
  pivot_wider(names_from = term,values_from = pass)%>%
  View()
```


```{r AAC102/3/4}
# GPA of 2.0 or higher across all courses that semester for a student.
# count of students pass AAC103
# AAC students' semester&cumulative GPA (2.0 threshold) by pass/fail of AAC

#How many students PASS AAC103 and finish the semester with a 2.0 or higher vs lower semester GPA; 
#How many students FAIL AAC103 and finish the semester with a 2.0 or higher vs lower than a 2.0 semester GPA
```









