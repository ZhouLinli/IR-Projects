---
title: "First Impression Survey Results"
author: ''
date: "Survey Collected during Sep 20-30, 2022"
output: 
  pdf_document: default
  word_document:
    reference_docx: /Users/linlizhou/Documents/Rprojects/lasell.report.docx
header-includes:
    - \usepackage{fancyhdr}
---
\addtolength{\headheight}{1.0cm} % make more space for the header
\pagestyle{fancyplain} % use fancy for all pages except chapter start
\rhead{\includegraphics[height=1.2cm]{/Users/linlizhou/Documents/Rprojects/Lasell_Monogram.jpg}} % right logo
\renewcommand{\headrulewidth}{0pt} % remove rule below header
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, warning=FALSE, message=FALSE) #show only results
source("/Users/linlizhou/Documents/Rprojects/IR-Projects/theme_source.R") #run code from saved theme and library

#output:
#  pdf_document: default
#  word_document:
#    reference_docx: /Users/linlizhou/Documents/Rprojects/lasell.report.docx

#output:
#  word_document:
#    toc: yes
#    reference_docx: "/Users/linlizhou/Documents/Rprojects/lasell.report.docx"
    
#output:
#  bookdown::word_document2:
#    fig_caption: yes
#    reference_docx: "/Users/linlizhou/Documents/Rprojects/lasell.report.docx"
```

```{r load and clean data}
#read data
fis<-read_csv("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Surveys/Lasell Internal/First Impressions/2022 Fall/20221013124928-SurveyExport.csv")
```


```{r match ppid from allstu22 for fis}
#fis email rename
fis<-fis%>%
  rename(email=`Please provide your Lasell email address. This information is needed for research purposes. Your personal information will be kept confidential and will not appear on any report. `)

#fis email.short
fis<-fis%>%
  mutate(email.short=gsub("@lasell.edu","",fis$email),#remove extra to keep all values the same format
         email.short=str_to_lower(email.short))%>%  #lower case
  select(-email)#to avoid too many cols get merged



#backup data email
allstu<-read_excel("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Registrar Reports/2022 Fall/Fall 2022 UG Backup Data Report.xlsx")

#select 2022 cohort and vars
allstu22<-allstu%>%
  filter(`Cohort Id`=="2022")%>%#this year's students
  select(`People Code Id`, Name,`Lasell email`,
         `Transfer YN`,`Res/Comm`,Gender,Ethnicity,`FT/PT`)%>%#select all usable vars
  rename(gender=Gender)#to avoid join by "Gender"

#create email.short
allstu22<-allstu22%>%
  mutate(email.short=gsub("@lasell.edu","",allstu22$`Lasell email`),#remove extra to match fis emails
         email.short=str_to_lower(email.short))%>%#keep lower case format
  select(-`Lasell email`)#avoid too many cols get merged


#merge
fis<-left_join(fis,allstu22,by="email.short")#all fis with a valid email will have a ppid and names now
#check: sum(is.na(fis$`People Code Id`));sum(is.na(fis$Name))#only 16 do not find a matched ppid/name
```


```{r select vars and SAVE fis.s}
#select: remove starter cols
fis.s<-fis%>%select(-(`Response ID`:Source),-(`Invite Custom Field 2`:Gender))%>%#removed 54 cols
  janitor::remove_empty(c("rows", "cols"))#remove empty rows/cols (including header has to be NA), removed 1 rows

#remove NA cols: nothing get removed
fis.s<-fis.s[ , colSums(is.na(fis.s)) < nrow(fis.s)] #sum each col's # of NA rows, as long as not all rows are NA then select them 

#check: names(fis)[names(fis)%in%names(fis.s)==FALSE]
```


```{r one ppid col}
#rename headers
#ppid
#check: sum(is.na(fis.s$`Invite Custom Field 1`));sum(is.na(fis.s$`People Code Id`))#148vs15
fis.s<-fis.s%>%mutate(ppid=if_else(!is.na(`Invite Custom Field 1`),#if settled by field then field
                            `Invite Custom Field 1`,`People Code Id`))%>%#if not settled, then matched id
  select(-`Invite Custom Field 1`,-`People Code Id`)
#check: sum(is.na(fis.s$ppid))#14 without ppid
```


```{r rename cols and SAVE xlsx}
#look at the survey instruction and lapply(fis.s, unique) to do this
fis.s<-fis.s%>%rename(
  RCstatus=`Which of the following describes your status for the 2022 fall semester?`,
#satisfaction 0-6 scale  
  satis.activity=`Campus-wide programs and activities (virtual or in-person)?:Please tell us how satisfied you are with…`,
  satis.activity.cm=`Comment or example::Please tell us how satisfied you are with…...58`,
  
  satis.overallcourse=`Your courses overall so far?:Please tell us how satisfied you are with…`,
  satis.majorcourse=`Your courses within your major so far? (If you are an undeclared major, please leave blank):Please tell us how satisfied you are with…`,
  satis.course.cm=`Comment or example::Please tell us how satisfied you are with…...61`,
  
  satis.acchallenge=`The degree of academic challenge in your courses?:Please tell us how satisfied you are with…`,
  satis.acchallenge.cm=`Comment or example::Please tell us how satisfied you are with…...63`,

  satis.accommit=`Other students' commitment to their studies?:Please tell us how satisfied you are with…`,
  satis.accommit.cm=`Comment or example::Please tell us how satisfied you are with…...65`,
  
  satis.foodav=`Food service availability on campus?:Please tell us how satisfied you are with…`,
  satis.foodav.cm=`Comment or example::Please tell us how satisfied you are with…...67`,
  
  satis.residstaff=`Residential Life staff?:Please tell us how satisfied you are with…`,
  satis.residstaff.cm=`Comment or example::Please tell us how satisfied you are with…...69`,
  
  satis.residhall=`Your living situation in the residence halls?:Please tell us how satisfied you are with…`,
  satis.residhall.cm=`Comment or example::Please tell us how satisfied you are with…...71`,

#connection 0-6 scale  
  connect.faculty=`Faculty?:How connected do you feel to…`,
  connect.faculty.cm=`Comment or example::How connected do you feel to…...73`,
  
  connect.stu=`Other students?:How connected do you feel to…`,
  connect.stu.cm=`Comment or example::How connected do you feel to…...75`,

#emphasis question: 4 text scale  
  emphasize.acsupport=`Using learning support services (tutoring services, writing center, etc):Based on your experience so far, how much does Lasell University emphasize the following?`,
  emphasize.socoppo=`Providing opportunities to be involved socially:Based on your experience so far, how much does Lasell University emphasize the following?`,
  emphasize.campactivity=`Attending campus activities and events (virtual or in-person):Based on your experience so far, how much does Lasell University emphasize the following?`,
  emphasize.issueevents=`Attending events that address important social, economic, or political issues:Based on your experience so far, how much does Lasell University emphasize the following?`,

#satisfaction 0-6 scale
  service.aac=`Academic Achievement Center:Please tell us how satisfied you are with…`,
  service.aac.cm=`Comment or Example::Please tell us how satisfied you are with…...81`,

  service.classtech=`Classroom Technology and Computer Labs:Please tell us how satisfied you are with…`,
  service.classtech.cm=`Comment or Example::Please tell us how satisfied you are with…...83`,

  service.counseling=`Counseling Center (Located at 18 Maple Terrace):Please tell us how satisfied you are with…`,
  service.counseling.cm=`Comment or Example::Please tell us how satisfied you are with…...85`,

  service.acadvisor=`Your academic advisor:Please tell us how satisfied you are with…`,
  service.acadvisor.cm=`Comment or Example::Please tell us how satisfied you are with…...87`,

  service.health=`Health Services (Located in Edwards Student Center):Please tell us how satisfied you are with…`,
  service.health.cm=`Comment or Example::Please tell us how satisfied you are with…...89`,

  service.techhelp=`Technology Help Desk:Please tell us how satisfied you are with…`,
  service.techhelp.cm=`Comment or Example::Please tell us how satisfied you are with…...91`,

  service.shuttle=`Lasell Shuttle:Please tell us how satisfied you are with…`,
  service.shuttle.cm=`Comment or Example::Please tell us how satisfied you are with…...93`,

  service.other=`Please type the service(s) in to the box (i.e. vending, mailroom, washing/drying etc.):Please provide feedback on any other services on campus we have not mentioned in the previous questions.`,
  service.other.cm=`Feedback::Please provide feedback on any other services on campus we have not mentioned in the previous questions.`,

#academic 0-6 scale
  meetacexpect=`Is the college meeting your expectations in terms of academic experience?:Please tell us a little bit about what you think of Lasell's academics.`,
  meetacexpect.cm=`Comment or example::Please tell us a little bit about what you think of Lasell's academics.`,

  faculty.orgmaterial=`Present material in a well-organized way?:How often do your faculty…`,
  faculty.explain=`Make good use of examples and illustrations to explain difficult points?:How often do your faculty…`,
  faculty.prep=`Come to class well prepared?:How often do your faculty…`,
  faculty.command=`Have a good command of what they are teaching?:How often do your faculty…`,

#outside class 0-6 agreement
  interact.outside=`I have had a positive interaction with at least one Lasell faculty or staff member outside of class.:How much do you agree…`,
  interact.cm=`How have you been able to effectively interact with others in the Lasell community in a safe manner so far this semester?`,
  interact.difficulty=`What are the difficulties you’re facing when interacting with others within the Lasell community this semester?`)

#write.xlsx(fis.s,"/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Surveys/Lasell Internal/First Impressions/2022 Fall/raw_renamed.xlsx")
```

## Survey respondents

```{r respondents vs overall SAVE full df}
#full merge survey data with all population data for background vars comparisions
#data merge full
fis.s<-fis.s%>%mutate(RespondentOverall="Respondents")
allstu22<-allstu22%>%mutate(RespondentOverall="All First-Year")%>%rename(ppid=`People Code Id`)
fulldf<-full_join(fis.s,allstu22)

#response rate
num.response=fulldf%>%filter(RespondentOverall=="Respondents")%>%nrow()
num.overall=fulldf%>%filter(RespondentOverall=="All First-Year")%>%nrow()
response_rate=formattable::percent(num.response/num.overall,digits=0)
```


```{r one RCstatus col in fulldf}
fulldf<-fulldf%>%mutate(Res_Com=if_else(!is.na(RCstatus),#if settled by RC then RC
          RCstatus,`Res/Comm`))%>%#if not settled, then res/com from allstu
  select(-RCstatus,-`Res/Comm`)%>%
  mutate(RCstatus=if_else(Res_Com=="R","Resident",
                          if_else(Res_Com=="C","Commuter",Res_Com)))%>%
  select(-Res_Com)
  
#check: fulldf.t%>%count(RCstatus)
```

```{r recode race in fulldf}
fulldf<-fulldf%>%mutate(Ethnicity=if_else(is.na(Ethnicity),"Race and Ethnicity Unknown",Ethnicity))%>%
  mutate(Ethnicity=if_else(Ethnicity=="Race and Ethnicity Unknown","Unknown",Ethnicity))%>%
  mutate(Ethnicity=if_else(Ethnicity=="Two or more Races","Multi-races",Ethnicity))%>%
  mutate(Ethnicity=if_else(Ethnicity=="Non Resident Alien","International",Ethnicity))%>%
  mutate(Ethnicity=if_else(Ethnicity=="Native Hawaiian or Other Pacific Islander","Native",Ethnicity))%>%
  mutate(Ethnicity=if_else(Ethnicity=="Black or African American","Black",Ethnicity))
```

```{r recode gender}
fulldf<-fulldf%>%mutate(gender=if_else(is.na(gender),"Unknown",gender))
```






```{r left merge allstu22.2}
#left merge survey data with all population data 
allstu22.s<-allstu22%>%select(-RespondentOverall)
allstu22.s<-allstu22.s%>%mutate(ResAll=
                        if_else(ppid%in%fis.s$ppid,#if id is one of the same survey id 
                        "Respond","Not Respond"))
#check: allstu22.s%>%count(ResAll) #314 person, 195 responded, 177 have ppid, 18 no ppid
```

```{r resp_rate,fig.fullwidth=TRUE}
resp_rate<-allstu22.s%>%group_by(ResAll)%>%summarise(cnt=n())%>%
 mutate(prt=round(cnt/sum(cnt)*100,digits = 0))%>%
  ggplot(aes(x=2, y = prt, fill=ResAll)) +#x=2 to place the pie centered on limit
    xlim(0.5, 2.5)+#only show .5-2.5 of pie (0-.5 will be the hole)
  geom_bar(stat="identity")+coord_polar(theta="y",start=0)+#make bar on a circled coord
  scale_fill_manual(values = c("grey","#69b3e7"))+
  annotate("text",x = 0.5, y = 0.5, #center is 0.5
           label = str_wrap(paste0(response_rate," Response Rate"),10))+#fontface=2 bolded
    theme_lz()+theme(legend.position = "none")+
  labs(#caption=str_wrap("Survey collected: Sep. 20-30, 2022",20),
       title="",x="",y="",fill="")
    #geom_text(aes(x =2,label = ResAll),position = position_stack(vjust = .5) )

#response rate
#ResAll.waffle<-fulldf%>%group_by(RespondentOverall)%>%summarise(cnt=n())%>%
 # mutate(prt=round(cnt/sum(cnt)*100,digits = 0))%>%
#ggplot(aes(values = prt, fill=RespondentOverall)) +
 # geom_waffle(color="white",flip = TRUE)+
  # labs(title=str_wrap(paste0(response_rate," Response Rate"),40),#, " (",num.response, " out of ", num.overall,")"),40),#80 is a full line length
   #    x="",y="",fill="", 40)+
       #subtitle=str_wrap("Data collection: Sep 20-30, 2022"),40)+ #shows bottom right
  #theme_lz()+
   # scale_y_discrete(labels=c("Respondents","All First-year"))+
  #scale_fill_manual(values = c("grey","#69b3e7"))#fill legend labels=c(""),name="")
 # geom_text(aes(x = prt, y=RespondentOverall, label=paste0(RespondentOverall,": ",prt)),color="white",position = position_dodge(0.9),hjust=1)

#response rate
#ResAll.number<-fulldf%>%count(RespondentOverall)%>%
#ggplot(aes(x = n, y=RespondentOverall, fill=RespondentOverall)) +
#  geom_col()+
#  labs(title=str_wrap(paste0(response_rate," Response Rate"),40),#, " (",num.response, " out of ", num.overall,")"),40),#80 is a full line length
#       x="",y="",fill="", 40)+
       #subtitle=str_wrap("Data collection: Sep 20-30, 2022"),40)+ #shows bottom right
#  theme_lz()+theme(legend.position = "none")+
    #scale_y_discrete(labels=c("Respondents","All First-year"))+
#  scale_fill_manual(values = c("#69b3e7","grey"))+#fill legend labels=c(""),name="")
#  geom_text(aes(label=paste0(RespondentOverall,": ",n)),color="white",position = position_dodge(0.9),hjust=1)
```


```{r respondent res.com figure}
#background info: gender & ethnicity, FT/PT & Transfer, RC
#RC
ResAll.rcstatus<-fulldf%>%group_by(RespondentOverall,RCstatus)%>%summarise(cnt=n())%>%
  mutate(prt=formattable::percent(cnt/sum(cnt),digits=0))%>%
  
ggplot(aes(x = prt, fill=RespondentOverall, y=RCstatus)) +
  geom_bar(stat="identity",position = position_dodge(),width=0.8)+
  labs(title=str_wrap("",40),#80 is a full line length
       x="",y="",fill="")+ 
  theme_lz()+
  theme(axis.text.y = element_text(),
        legend.position = "none")+
    scale_y_discrete(labels=c("Commuters","Residents"))+
  geom_text(aes(label=paste0(prt)),size=3,fontface="bold",position = position_dodge(0.9))+#, " ", RCstatus," among ",RespondentOverall
  scale_fill_manual(values = c("grey","#69b3e7"))#+#fill legend labels=c(""),name="")
 # coord_flip()
```

```{r respondent gender figure}
#background info: gender & ethnicity, FT/PT & Transfer, RC
#RC
ResAll.gd<-fulldf%>%filter(gender!="Unknown")%>%
  group_by(RespondentOverall,gender)%>%summarise(cnt=n())%>%
  mutate(prt=formattable::percent(cnt/sum(cnt),digits=0))%>%
  
ggplot(aes(x = prt, fill=RespondentOverall, y=gender)) +
  geom_bar(stat="identity",position = position_dodge(),width=0.8)+
  labs(title=str_wrap("",40),#80 is a full line length
       x="",y="",fill="")+ 
  theme_lz()+
  theme(axis.text.y = element_text(), legend.position = "none")+
    scale_y_discrete(labels=c("Male","Female"))+
  geom_text(aes(label=paste0(prt)),size=3,fontface="bold",position = position_dodge(0.9))+#, " ", gender," among ",RespondentOverall
  scale_fill_manual(values = c("grey","#69b3e7"))#+#fill legend labels=c(""),name="")
  #coord_flip()
```


```{r respondent ethnicity figure}
ResAll.eth<-fulldf%>%filter(Ethnicity!="Unknown")%>%
  group_by(RespondentOverall,Ethnicity)%>%summarise(cnt=n())%>%
  mutate(prt=formattable::percent(cnt/sum(cnt),digits=0))%>%
  
  ggplot(aes(x = prt, fill=RespondentOverall, y=reorder(Ethnicity,(-prt))))+
  geom_bar(stat="identity",position = position_dodge(),width=0.8)+
  labs(title=str_wrap("",40),x="",y="",fill="") +
  theme_lz()+theme(axis.text.x = element_text(), legend.position = c(0.8,0.8))+
  geom_text(aes(label=paste0(prt)),size=3,fontface="bold",position = position_dodge(0.9))+
  scale_y_discrete(guide=guide_axis(n.dodge = 2))+
  scale_fill_manual(values = c("grey","#69b3e7"))+#fill legend labels=c(""),name="")
  coord_flip()

#pvttbl<-fulldf%>%filter(Ethnicity!="Unknown")%>%
 # group_by(RespondentOverall,Ethnicity)%>%summarise(cnt=n())%>%
  #mutate(prt=formattable::percent(cnt/sum(cnt),digits=0))

#set_order <- pvttbl%>% filter(RespondentOverall=="All First-Year Students") %>%
 #             arrange(prt) %>%mutate(eth_reorder = factor(Ethnicity))

#ResAll.eth<-pvttbl%>%
#ggplot(aes(x = prt, fill=RespondentOverall, y=Ethnicity)) +
 # geom_bar(stat="identity",position = position_dodge(),width=0.8)+
  #labs(title=str_wrap("",40),#80 is a full line length
   #    x="",y="",fill="") +
  #theme_lz()+
  #theme(axis.text.x = element_text(), legend.position = c(0.5,0.8))+
#  scale_y_discrete(limits = set_order$eth_reorder)+
 # geom_text(aes(label=paste0(prt)),size=3,position = position_dodge(0.9))+
  #scale_fill_manual(values = c("grey","#69b3e7"))+#fill legend labels=c(""),name="")
  #coord_flip()
```

```{r combine 2 first}
fig_gd.rc<-gridExtra::grid.arrange(ResAll.rcstatus, ResAll.gd, nrow=2)
```


```{r respondent_figures,include=TRUE,fig.height=2.5}
gridExtra::grid.arrange(resp_rate,fig_gd.rc, nrow=1, widths=c(1,1))
#layout(matrix(c(1,2,3),nrow=1,ncol=3,byrow = TRUE))
#ResAll.rcstatus+ ResAll.gd+ ResAll.eth +plot_layout(ncol = 3)
```

```{r,include=TRUE,fig.height=2}
ResAll.eth
```







```{r historical data}
historical<-read_excel("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Surveys/Lasell Internal/First Impressions/2022 Fall/HistoricalItems.xlsx")

historical$`2018`<-as.numeric(historical$`2018`)

historical<-tidyr::pivot_longer(historical,cols=c(`2018`:`2021`),names_to = "year",values_to = "prt")
```


```{r current data - distill one satis number}
#check: lapply(fis.s[,str_detect(names(fis.s),"cm$")==FALSE],unique)%>%View()

##satis.t
satis.t1<-fis.s%>%filter(!is.na(satis.activity))%>%#remove NA from total
  group_by(satis.activity)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(satis.activity>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="satis.activity")%>%select(item,year,prt)#select needed vars and values

satis.t2<-fis.s%>%filter(!is.na(satis.overallcourse))%>%#remove NA from total
  group_by(satis.overallcourse)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(satis.overallcourse>3,"Satisfied","Dissadisfied"))%>%
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="satis.overallcourse")%>%select(item,year,prt)

satis.t3<-fis.s%>%filter(!is.na(satis.majorcourse))%>%#remove NA from total
  group_by(satis.majorcourse)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(satis.majorcourse>3,"Satisfied","Dissadisfied"))%>%
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="satis.majorcourse")%>%select(item,year,prt)

satis.t4<-fis.s%>%filter(!is.na(satis.acchallenge))%>%#remove NA from total
  group_by(satis.acchallenge)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(satis.acchallenge>3,"Satisfied","Dissadisfied"))%>%
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="satis.acchallenge")%>%select(item,year,prt)

satis.t5<-fis.s%>%filter(!is.na(satis.accommit))%>%#remove NA from total
  group_by(satis.accommit)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(satis.accommit>3,"Satisfied","Dissadisfied"))%>%
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="satis.accommit")%>%select(item,year,prt)

satis.t6<-fis.s%>%filter(!is.na(satis.foodav))%>%#remove NA from total
  group_by(satis.foodav)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(satis.foodav>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="satis.foodav")%>%select(item,year,prt)

satis.t7<-fis.s%>%filter(!is.na(satis.residstaff))%>%#remove NA from total
  group_by(satis.residstaff)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(satis.residstaff>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="satis.residstaff")%>%select(item,year,prt)

satis.t8<-fis.s%>%filter(!is.na(satis.residhall))%>%#remove NA from total
  group_by(satis.residhall)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(satis.residhall>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="satis.residhall")%>%select(item,year,prt)


##emphasize faculty and connect
#emphasize
emp1<-fis.s%>%filter(!is.na(emphasize.acsupport))%>%#remove NA from total
  group_by(emphasize.acsupport)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(emphasize.acsupport%in%c("Very much","Quite a bit"),
                         "Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="emphasize.acsupport")%>%select(item,year,prt)

emp2<-fis.s%>%filter(!is.na(emphasize.socoppo))%>%#remove NA from total
  group_by(emphasize.socoppo)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(emphasize.socoppo%in%c("Very much","Quite a bit"),
                         "Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="emphasize.socoppo")%>%select(item,year,prt)

emp3<-fis.s%>%filter(!is.na(emphasize.campactivity))%>%#remove NA from total
  group_by(emphasize.campactivity)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(emphasize.campactivity%in%c("Very much","Quite a bit"),
                         "Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="emphasize.campactivity")%>%select(item,year,prt)

emp4<-fis.s%>%filter(!is.na(emphasize.issueevents))%>%#remove NA from total
  group_by(emphasize.issueevents)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(emphasize.issueevents%in%c("Very much","Quite a bit"),
                         "Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="emphasize.issueevents")%>%select(item,year,prt)

expect.t1<-fis.s%>%filter(!is.na(meetacexpect))%>%#remove NA from total
  group_by(meetacexpect)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(meetacexpect>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="meetacexpect")%>%select(item,year,prt)
#faculty
faculty.t1<-fis.s%>%filter(!is.na(faculty.orgmaterial))%>%#remove NA from total
  group_by(faculty.orgmaterial)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(faculty.orgmaterial>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="faculty.orgmaterial")%>%select(item,year,prt)

faculty.t2<-fis.s%>%filter(!is.na(faculty.explain))%>%#remove NA from total
  group_by(faculty.explain)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(faculty.explain>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="faculty.explain")%>%select(item,year,prt)

faculty.t3<-fis.s%>%filter(!is.na(faculty.prep))%>%#remove NA from total
  group_by(faculty.prep)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(faculty.prep>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="faculty.prep")%>%select(item,year,prt)

faculty.t4<-fis.s%>%filter(!is.na(faculty.command))%>%#remove NA from total
  group_by(faculty.command)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(faculty.command>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="faculty.command")%>%select(item,year,prt)

#connect.t1<-mean(fis.s$connect.faculty, na.rm = TRUE)
#connect.t2<-mean(fis.s$connect.stu, na.rm = TRUE)
connect.t1<-fis.s%>%filter(!is.na(connect.faculty))%>%#remove NA from total
  group_by(connect.faculty)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(connect.faculty>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="connect.faculty")%>%select(item,year,prt)

connect.t2<-fis.s%>%filter(!is.na(connect.stu))%>%#remove NA from total
  group_by(connect.stu)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(connect.stu>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="connect.stu")%>%select(item,year,prt)

connect.t3<-fis.s%>%filter(!is.na(interact.outside))%>%#remove NA from total
  group_by(interact.outside)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(interact.outside>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="interact.outside")%>%select(item,year,prt)

## service
service.u1<-fis.s%>%filter(!is.na(service.aac))%>%#remove NA from total
  group_by(service.aac)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.aac=="Have not use","Not-use","Used"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Used")%>%mutate(year="2022",item="service.aac.use")%>%select(item,year,prt)

service.s1<-fis.s%>%filter(!is.na(service.aac)&service.aac!="Have not use")%>%#remove NA from total
  group_by(service.aac)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.aac>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="service.aac.satis")%>%select(item,year,prt)


service.u2<-fis.s%>%filter(!is.na(service.classtech))%>%#remove NA from total
  group_by(service.classtech)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.classtech=="Have not use","Not-use","Used"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Used")%>%mutate(year="2022",item="service.classtech.use")%>%select(item,year,prt)

service.s2<-fis.s%>%filter(!is.na(service.classtech)&service.classtech!="Have not use")%>%#remove NA from total
  group_by(service.classtech)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.classtech>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="service.classtech.satis")%>%select(item,year,prt)


service.u3<-fis.s%>%filter(!is.na(service.counseling))%>%#remove NA from total
  group_by(service.counseling)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.counseling=="Have not use","Not-use","Used"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Used")%>%mutate(year="2022",item="service.counseling.use")%>%select(item,year,prt)

service.s3<-fis.s%>%filter(!is.na(service.counseling)&service.counseling!="Have not use")%>%#remove NA from total
  group_by(service.counseling)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.counseling>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="service.counseling.satis")%>%select(item,year,prt)


service.u4<-fis.s%>%filter(!is.na(service.acadvisor))%>%#remove NA from total
  group_by(service.acadvisor)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.acadvisor=="Have not met with advisor","Not-use","Used"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Used")%>%mutate(year="2022",item="service.acadvisor.use")%>%select(item,year,prt)

service.s4<-fis.s%>%filter(!is.na(service.acadvisor)&service.acadvisor!="Have not met with advisor")%>%#remove NA from total
  group_by(service.acadvisor)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.acadvisor>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="service.acadvisor.satis")%>%select(item,year,prt)


service.u5<-fis.s%>%filter(!is.na(service.health))%>%#remove NA from total
  group_by(service.health)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.health=="Have not use","Not-use","Used"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Used")%>%mutate(year="2022",item="service.health.use")%>%select(item,year,prt)

service.s5<-fis.s%>%filter(!is.na(service.health)&service.health!="Have not use")%>%#remove NA from total
  group_by(service.health)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.health>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="service.health.satis")%>%select(item,year,prt)


service.u6<-fis.s%>%filter(!is.na(service.techhelp))%>%#remove NA from total
  group_by(service.techhelp)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.techhelp=="Have not use","Not-use","Used"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Used")%>%mutate(year="2022",item="service.techhelp.use")%>%select(item,year,prt)

service.s6<-fis.s%>%filter(!is.na(service.techhelp)&service.techhelp!="Have not use")%>%#remove NA from total
  group_by(service.techhelp)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.techhelp>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="service.techhelp.satis")%>%select(item,year,prt)


service.u7<-fis.s%>%filter(!is.na(service.shuttle))%>%#remove NA from total
  group_by(service.shuttle)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.shuttle=="Have not use","Not-use","Used"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Used")%>%mutate(year="2022",item="service.shuttle.use")%>%select(item,year,prt)

service.s7<-fis.s%>%filter(!is.na(service.shuttle)&service.shuttle!="Have not use")%>%#remove NA from total
  group_by(service.shuttle)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.shuttle>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="service.shuttle.satis")%>%select(item,year,prt)


service.u8<-fis.s%>%filter(!is.na(service.aac))%>%#remove NA from total
  group_by(service.aac)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.aac=="Have not use","Not-use","Used"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Used")%>%mutate(year="2022",item="service.aac.use")%>%select(item,year,prt)

service.s8<-fis.s%>%filter(!is.na(service.aac)&service.aac!="Have not use")%>%#remove NA from total
  group_by(service.aac)%>%summarise(cnt=n())%>%#count each 6 groups
  mutate(regroup=if_else(service.aac>3,"Satisfied","Dissadisfied"))%>%#converge to 2 group
  group_by(regroup)%>%summarise(regroup.cnt=sum(cnt))%>%#group regrouped and sum previous cnt
  mutate(prt=formattable::percent(regroup.cnt/sum(regroup.cnt),digits = 0))%>%#prt within regroups
  filter(regroup=="Satisfied")%>%mutate(year="2022",item="service.aac.satis")%>%select(item,year,prt)

current<-rbind(connect.t1,connect.t2,connect.t3,
      emp1,emp2,emp3,emp4,
      expect.t1,
      faculty.t1,faculty.t2,faculty.t3,faculty.t4,
      satis.t1,satis.t2,satis.t3,satis.t4,satis.t5,satis.t6,satis.t7,satis.t8,
      service.s1,service.s2,service.s3,service.s4,service.s5,service.s6,service.s7,service.s8,
      service.u1,service.u2,service.u3,service.u4,service.u5,service.u6,service.u7,service.u8)
```

```{r merge hist and current and SAVE prtdf}
historical.prt<-historical%>%filter(prt<1)%>%mutate(prt=formattable::percent(prt,digits = 0))
prtdf<-full_join(current,historical.prt)%>%unique()

#save: 
write_xlsx(prtdf, "/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Surveys/Lasell Internal/First Impressions/2022 Fall/satisfaction18-22.xlsx")

#check: 
prtdf%>%count(item)%>%View()
#sample_needed=Z^2*p*(1-p)/MOE^2
#margin of error=Z*p/sqrt(sample_n)
```


# Satisfaction
```{r satis1-8}
#satis.4: satis.acchallenge, satis.accommit, satis.majorcourse, satis.overallcourse
satis.aca.figure<-prtdf%>%filter(item%in%c("satis.overallcourse","satis.majorcourse", "satis.acchallenge", "satis.accommit"),year>2019)%>%
  group_by(item,year,prt)%>%summarise(cnt=n())%>%
  
  ggplot(aes(y = prt, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.8)+
  scale_fill_manual(values = c("Grey","Grey70","#69b3e7"))+
  labs(title=str_wrap("",40),x="",y="",fill="") +
  theme_lz()+theme(legend.position = "right",legend.direction = "vertical")+
  geom_text(aes(label= ifelse(year==2022,as.character(round(prt,2)),"")),
            size=3,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label= ifelse(year!=2022,as.character(round(prt,2)),"")),
            size=3,color="#6C6F70",fontface="bold",position = position_dodge(0.9))+
  
  facet_wrap(~factor(item,levels =c("satis.overallcourse","satis.majorcourse", "satis.acchallenge", "satis.accommit"),labels = c(str_wrap("Overall Courses",10),
                             str_wrap("Major Courses",10),
                             str_wrap("Academic Challenge",10),
                             str_wrap("Academic Commitment",10))),nrow=1) +
  geom_line(aes(y = prt, x=year, group=item, 
                color=factor(item,levels =c("satis.overallcourse","satis.majorcourse", "satis.acchallenge", "satis.accommit")), 
                linetype=factor(item,levels =c("satis.overallcourse","satis.majorcourse", "satis.acchallenge", "satis.accommit"))),
            stat="identity", show.legend = F)+#
  scale_color_manual(name="",values=c("black","#6C6F70","#6C6F70","#6C6F70"))+
  scale_linetype_manual(name="",values=c("solid","dashed","dashed","dashed"))

#satis.4: satis.activity, satis.foodav, satis.residhall, satis.residstaff
```

```{r satis figure, include=TRUE, fig.height=2}
satis.aca.figure
```


## Services Use and Satisfaction
```{r service1-7.use/.satis}
#service.4: service.aac, service.acadvisor, service.classtech, , service.techhelp
#service.3: service.counseling, service.health, service.shuttle 
```

## Emphasize, Faculty, and Connect
```{r}
#empashize4: emphasize.acsupport, emphasize.campactivity, emphasize.issueevents, emphasize.socoppo

#faculty4: faculty.command, faculty.explain, faculty.orgmaterial, faculty.prep

#connect4: connect.faculty, connect.stu, interact.outside, meetacexpect
```


## Qualitative Analysis

## Ethnicity and Inclusion
```{r table by gender and race this year}

```








